<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P.D.A Chat</title>
  <style>
    :root {
      --bg: #000;
      --surface: #1a1a1a;
      --border: #333;
      --text: #e0e0e0;
      --text-muted: #888;
      --accent: #555;
      --hover: #2a2a2a;
      --sent: #444;
      --received: #222;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      font-size: 16px;
      background-color: var(--bg);
      color: var(--text);
      max-width: 640px;
      margin: 0 auto;
      padding: 16px;
      line-height: 1.5;
    }

    header {
      text-align: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-weight: 600;
      font-size: 28px;
      letter-spacing: -0.5px;
      color: #ccc;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #chat {
      background-color: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      height: 360px;
      overflow-y: auto;
      padding: 16px;
      font-size: 15px;
      line-height: 1.6;
      scroll-behavior: smooth;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .message {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      word-wrap: break-word;
    }

    .message.sent {
      background-color: var(--sent);
      margin-left: 24px;
    }

    .message.received {
      background-color: var(--received);
      margin-right: 24px;
    }

    .message time {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .nick {
      font-weight: 600;
      color: #b0b0b0;
    }

    .input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    input, button {
      padding: 10px 14px;
      font-size: 15px;
      background-color: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      transition: all 0.2s ease;
    }

    input:focus, button:focus {
      border-color: #666;
      box-shadow: 0 0 0 2px rgba(100, 100, 100, 0.3);
    }

    #nick {
      flex: 1;
      min-width: 140px;
    }

    #msg {
      flex: 2;
      min-width: 200px;
    }

    button {
      background-color: var(--accent);
      cursor: pointer;
      font-weight: bold;
      width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:hover:not(:disabled) {
      background-color: #666;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .init {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-style: italic;
    }

    @media (max-width: 500px) {
      #nick, #msg {
        flex: 1 1 100%;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>P.D.A</h1>
  </header>

  <div class="container">
    <div id="chat">
      <div class="init">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
    </div>

    <div class="input-area">
      <input type="text" id="nick" placeholder="–ò–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –¥–æ 15)" maxlength="15" autocomplete="off">
      <input type="text" id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" disabled autocomplete="off">
      <button id="send" disabled>‚û§</button>
    </div>
  </div>

  <!-- Firebase SDK (Compat Mode) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <script>
    // === Firebase config (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω URL: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–±–µ–ª—ã!)
    const config = {
      databaseURL: "https://my-chat-site-2d226-default-rtdb.firebaseio.com/"
    };

    let db;
    try {
      const app = firebase.initializeApp(config);
      db = app.database();
    } catch (e) {
      console.error('Firebase init failed:', e);
      document.getElementById('chat').innerHTML = `<div class="init">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É</div>`;
    }

    const chatEl = document.getElementById('chat');
    const nickInp = document.getElementById('nick');
    const msgInp = document.getElementById('msg');
    const sendBtn = document.getElementById('send');

    let userNick = localStorage.getItem('userNick') || null;

    function validateNick(nick) {
      return /^[a-zA-Z0-9_-]{1,15}$/.test(nick.trim());
    }

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (userNick && validateNick(userNick)) {
      nickInp.value = userNick;
      nickInp.disabled = true;
      msgInp.disabled = false;
      sendBtn.disabled = false;
      chatEl.innerHTML = ''; // —É–±–∏—Ä–∞–µ–º "–æ–∂–∏–¥–∞–Ω–∏–µ"
    } else {
      userNick = null;
      localStorage.removeItem('userNick');
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∏–∫–∞
    nickInp.addEventListener('keypress', e => {
      if (e.key === 'Enter' && !userNick) {
        const raw = nickInp.value;
        if (validateNick(raw)) {
          userNick = raw.trim();
          localStorage.setItem('userNick', userNick);
          nickInp.value = userNick;
          nickInp.disabled = true;
          msgInp.disabled = false;
          sendBtn.disabled = false;
          msgInp.focus();
          chatEl.innerHTML = ''; // —á–∏—Å—Ç–∏–º "–æ–∂–∏–¥–∞–Ω–∏–µ"
        } else {
          nickInp.value = '';
          nickInp.placeholder = '–¢–æ–ª—å–∫–æ a-z, 0-9, _-';
          setTimeout(() => nickInp.placeholder = '–ò–º—è (–ª–∞—Ç–∏–Ω–∏—Ü–∞, –¥–æ 15)', 2000);
        }
      }
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞
    function send() {
      const text = msgInp.value.trim();
      if (!userNick || !text || !db) return;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      db.ref('messages').push({
        nick: userNick,
        text: text,
        ts: firebase.database.ServerValue.TIMESTAMP
      });

      // –û—á–∏—â–∞–µ–º
      msgInp.value = '';
      msgInp.focus();
    }

    sendBtn.addEventListener('click', send);
    msgInp.addEventListener('keypress', e => {
      if (e.key === 'Enter') send();
    });

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    msgInp.addEventListener('input', () => {
      sendBtn.disabled = !msgInp.value.trim();
    });

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (db) {
      db.ref('messages').limitToLast(100).on('child_added', snap => {
        const data = snap.val();
        if (!data || !data.nick || !data.text) return;

        const div = document.createElement('div');
        const time = data.ts ? new Date(data.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

        div.className = `message ${data.nick === userNick ? 'sent' : 'received'}`;
        div.innerHTML = `
          <span class="nick">${this.escapeHtml(data.nick)}</span>: 
          ${this.escapeHtml(data.text)}
          ${time ? `<time>${time}</time>` : ''}
        `;

        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
      });

      // –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ‚Äî —É–±–∏—Ä–∞–µ–º "–æ–∂–∏–¥–∞–Ω–∏–µ"
      setTimeout(() => {
        if (chatEl.querySelector('.init')) {
          chatEl.innerHTML = '<div class="init">üí¨ –ß–∞—Ç –≥–æ—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –Ω–∞–∂–º–∏—Ç–µ Enter.</div>';
        }
      }, 1500);
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Ç–∏–≤ XSS
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>
