<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roblox –û–Ω–ª–∞–π–Ω-–ú–æ–Ω–∏—Ç–æ—Ä</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .add-section {
      text-align: center;
      margin-bottom: 20px;
    }
    .servers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .server {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 16px;
      text-align: center;
      transition: transform 0.2s;
    }
    .server:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .server-id {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
    }
    .server-name {
      font-weight: bold;
      font-size: 16px;
      margin: 8px 0;
      color: #333;
      word-break: break-word;
    }
    .server-online {
      font-size: 28px;
      font-weight: bold;
      color: #2e8b57;
      margin: 10px 0;
    }
    .server-error {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 8px;
    }
    input {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 8px;
    }
    button:hover {
      background: #0056b3;
    }
    .remove-btn {
      background: #dc3545;
      margin-left: 6px;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>üéÆ Roblox –û–Ω–ª–∞–π–Ω-–ú–æ–Ω–∏—Ç–æ—Ä</h1>
  <p>–î–æ–±–∞–≤—å—Ç–µ Place ID –∏–≥—Ä ‚Äî –æ–Ω–ª–∞–π–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É</p>
</div>

<div class="add-section">
  <input type="text" id="newPlaceId" placeholder="–í–≤–µ–¥–∏—Ç–µ Place ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789)" />
  <button onclick="addServer()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
</div>

<div id="servers" class="servers">
  <!-- –°–µ—Ä–≤–µ—Ä–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
</div>

<script>
  const UPDATE_INTERVAL = 3000; // 3 —Å–µ–∫ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
  const RETRY_DELAY = 2000; // –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
  let servers = JSON.parse(localStorage.getItem('robloxServers')) || [];
  let isUpdating = false;

  function addServer() {
    const input = document.getElementById('newPlaceId');
    const placeId = input.value.trim();
    if (!placeId || isNaN(placeId)) {
      alert('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —á–∏—Å–ª–æ–≤–æ–π Place ID');
      return;
    }
    if (servers.some(s => s.id === placeId)) {
      alert('‚ö†Ô∏è –≠—Ç–∞ –∏–≥—Ä–∞ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      return;
    }
    servers.push({ id: placeId, name: '–ó–∞–≥—Ä—É–∑–∫–∞...', online: 0, error: null });
    saveServers();
    renderServers();
    input.value = '';
    queueUpdate(placeId); // —Å—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º
  }

  function removeServer(placeId) {
    servers = servers.filter(s => s.id !== placeId);
    saveServers();
    renderServers();
  }

  function saveServers() {
    localStorage.setItem('robloxServers', JSON.stringify(servers));
  }

  function renderServers() {
    const container = document.getElementById('servers');
    container.innerHTML = '';
    if (servers.length === 0) {
      container.innerHTML = '<p style="text-align:center;color:#777">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–≥—Ä. –í–≤–µ–¥–∏—Ç–µ Place ID –≤—ã—à–µ.</p>';
      return;
    }
    servers.forEach(s => {
      const div = document.createElement('div');
      div.className = 'server';
      const onlineDisplay = s.online !== null ? s.online.toLocaleString() : '‚Äî';
      div.innerHTML = `
        <div><strong>ID:</strong> ${s.id} 
          <button class="remove-btn" onclick="removeServer('${s.id}')">√ó</button>
        </div>
        <div class="server-name">${s.name || '‚Äî'}</div>
        <div class="server-online">${onlineDisplay}</div>
        ${s.error ? `<div class="server-error">${s.error}</div>` : ''}
        <div class="server-id">Place ID: ${s.id}</div>
      `;
      container.appendChild(div);
    });
  }

  // üîÅ –û—á–µ—Ä–µ–¥—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî –Ω–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –∞ –ø–æ –æ–¥–Ω–æ–º—É
  const updateQueue = [];
  function queueUpdate(placeId) {
    if (!updateQueue.includes(placeId)) {
      updateQueue.push(placeId);
      processQueue();
    }
  }

  async function processQueue() {
    if (isUpdating || updateQueue.length === 0) return;
    isUpdating = true;
    const placeId = updateQueue.shift();
    try {
      await fetchServerData(placeId);
    } catch (err) {
      console.warn(`–û—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ–≤—Ç–æ—Ä –¥–ª—è ${placeId} —á–µ—Ä–µ–∑ ${RETRY_DELAY}–º—Å`);
      setTimeout(() => {
        updateQueue.push(placeId);
        processQueue();
      }, RETRY_DELAY);
    } finally {
      isUpdating = false;
      if (updateQueue.length > 0) setTimeout(processQueue, 100);
    }
  }

  async function fetchServerData(placeId) {
    const server = servers.find(s => s.id === placeId);
    if (!server) return;

    server.name = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    server.error = null;
    renderServers(); // –ø–æ–∫–∞–∂–µ–º "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."

    try {
      // üåê –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å Universe ID
      const placeRes = await fetch(`https://games.roblox.com/v1/games/multiget?placeIds=${placeId}`, {
        method: 'GET',
        mode: 'cors',
        headers: { 'Accept': 'application/json' }
      });

      if (!placeRes.ok) {
        throw new Error(`HTTP ${placeRes.status} ‚Äî ${placeRes.statusText}`);
      }

      const placeData = await placeRes.json();
      if (!Array.isArray(placeData) || placeData.length === 0 || !placeData[0]?.universeId) {
        throw new Error('–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞');
      }

      const universeId = placeData[0].universeId;
      const name = placeData[0].name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

      // üåê –®–∞–≥ 2: –ü–æ–ª—É—á–∏—Ç—å –æ–Ω–ª–∞–π–Ω
      const uniRes = await fetch(`https://games.roblox.com/v1/games?universeIds=${universeId}`, {
        method: 'GET',
        mode: 'cors'
      });

      if (!uniRes.ok) {
        throw new Error(`HTTP ${uniRes.status}`);
      }

      const uniData = await uniRes.json();
      const playing = uniData.data?.[0]?.playing || 0;

      // ‚úÖ –£—Å–ø–µ—Ö
      Object.assign(server, { name, online: playing, error: null });
    } catch (err) {
      console.error(`–û—à–∏–±–∫–∞ –¥–ª—è ${placeId}:`, err);
      server.name = '–û—à–∏–±–∫–∞';
      server.online = null;
      server.error = `‚ùå ${err.message}`;
    } finally {
      saveServers();
      renderServers();
    }
  }

  // ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  function startAutoUpdate() {
    // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
    servers.forEach(s => queueUpdate(s.id));
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    setInterval(() => {
      servers.forEach(s => queueUpdate(s.id));
    }, UPDATE_INTERVAL);
  }

  renderServers();
  startAutoUpdate();
</script>

</body>
</html>
